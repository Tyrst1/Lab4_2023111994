name: CI with Tests and Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ "main", "master" ]

jobs:
  # ç¬¬ä¸€ä¸ªå·¥ä½œï¼šè¿è¡Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. è®¾ç½®Javaç¯å¢ƒï¼ˆä½¿ç”¨JDK 17ï¼‰
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
        
    # 3. ç¼“å­˜Mavenä¾èµ–
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-
          
    # 4. ç¼–è¯‘é¡¹ç›®
    - name: Compile with Maven
      run: mvn clean compile
      
    # 5. è¿è¡Œæµ‹è¯•
    - name: Run tests with Maven
      run: mvn test
      
  # ç¬¬äºŒä¸ªå·¥ä½œï¼šè‡ªåŠ¨åˆå¹¶PRï¼ˆåªåœ¨æµ‹è¯•é€šè¿‡ä¸”PRæ¥è‡ªå¯ä¿¡æºæ—¶ï¼‰
  auto-merge:
    # æ¡ä»¶ï¼štestå·¥ä½œæˆåŠŸå®Œæˆï¼Œå¹¶ä¸”ä¸æ˜¯æ¥è‡ªforkçš„PR
    needs: test
    if: |
      needs.test.result == 'success' &&
      github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref }}
    
    - name: Auto merge pull request
      uses: actions/github-script@v7
      with:
        script: |
          const pullRequest = context.payload.pull_request;
          
          // æ£€æŸ¥PRæ˜¯å¦å¯åˆå¹¶
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: pullRequest.number
          });
          
          if (pr.mergeable) {
            // å¦‚æœå¯ä»¥åˆå¹¶ï¼Œæ·»åŠ è¯„è®ºå¹¶åˆå¹¶
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequest.number,
              body: 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ­£åœ¨è‡ªåŠ¨åˆå¹¶PR...'
            });
            
            try {
              // åˆå¹¶PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pullRequest.number,
                commit_title: `Merge pull request #${pullRequest.number}`,
                commit_message: `è‡ªåŠ¨åˆå¹¶ï¼š${pullRequest.title}`,
                merge_method: 'merge'
              });
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequest.number,
                body: 'ğŸ‰ PRå·²è‡ªåŠ¨åˆå¹¶ï¼'
              });
              
            } catch (error) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pullRequest.number,
                body: `âŒ åˆå¹¶å¤±è´¥ï¼š${error.message}`
              });
              throw error;
            }
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequest.number,
              body: 'âš ï¸ æ­¤PRå­˜åœ¨åˆå¹¶å†²çªï¼Œæ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œè¯·æ‰‹åŠ¨è§£å†³ã€‚'
            });
          }
